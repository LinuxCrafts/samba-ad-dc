# Docker - Samba4 Active Directory Domain Controller



## Overview
This repository provides a self-contained fully automated, easy to setup Docker container to run a [Samba 4](htts://www.samba.org/) _**Active Directory Domain Controller (AC DC)**_.  


## Quick Start

### Build
```bash
$ git clone https://github.com/LinuxCrafts/samba-ad-dc.git samba-ad-dc
$ docker build samba-ad-dc -t samba-ad-dc:custom
```


## Usage

### First run
```bash
$ docker run \
    --env "ADMIN_PASSWORD=Re4lly_Str0ng_Passw0rd" \
    --volume /path/to/samba/dir:/samba \
    --cap-add SYS_ADMIN \
    linuxcrafts/samba-ad-dc:latest
```
When the container is run for ther first time it will launch the domain provision script, after that invoke it with the following command.

```bash
$ docker run --restart always \
    --detach \
    --volume /path/to/samba/dir:/samba \
    --cap-add SYS_ADMIN \
    linuxcrafts/samba-ad-dc:latest
```
* **Note:** Usage of switch --cap-add _SYS_ADMIN_ is mandatory.

### Persisting Data
To persist data (such as user accounts, groups or logs) beyond container restarts, you can mount a volume to the container's /samba directory. You can learn more about volumes in [Docker's Official Documentation](https://docs.docker.com/storage/volumes/)

To create a persisten volume for container

```bash
$ docker volume create SAMBA_VOLUME
```


| NAME | LOCATION | CONTENT |
|------|-------|-------------|
| SAMBA | /samba | Samba settings, logs, data and runtime files |
| BIND-DNS| /bind-dns | Samba integration with bind9 dns service
| NTP | /ntp_signd | Samba secure socket for NTP

DO NOT EDIT /samba/etc/smb.conf, place your custom settings under /samba/etc/smb.conf.d/
. You can use overwrite any previous setting by editing /samba/etc/smb.conf.d/59-custom.conf for convienience and 99-custom_shares.conf to add new shares.

You can check smb.conf manual page for more options on [Samba Project's official web site](https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html)


## Environment Variables


The following environment variables are available for your configuration
pleasure:

| NAME | DEFAULT VALUE | DESCRIPTION |
|------|---------|-------------|
| DNS_DOMAIN | local.company.tld | DNS Domain
| DNS_FORWARDER | (empty) | DNS servers that DNS requests will be forwarded to if they can not be handled by Samba itself
| DNS_REVERSE_ZONE | AUTOGENERATED | Network DNS reverse zone (ex. 0.168.192.in-addr.arpa)
| WORKGROUP | LOCAL | NetBIOS Domain Name
| REALM | LOCAL.COMPANY.LTD | Kerberos Realm
| NETBIOS_NAME | $HOSTNAME | Docker image hostname
| DNS_BACKEND | SAMBA_INTERNAL | DNS server backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ)
| FUNCTION_LEVEL | 2008_R2 | Domain and forest function level ( 2000, 2003, 2008, 2008_R2 )
| BACKEND_STORE| tdb | Specify the database backend to be used |

If $DNS_DOMAIN is not supplied the /samba-ad-dc script will first attempt to get the value from hostname -d; if empty then will look for it in /etc/resolv.conf, else if $REALM is supplied it will lowerc

## Exposed ports
| PORT | PROTOCOL | DESCRIPTION | 
|------|----------|-------------|
| 53 | TCP/UDP | DNS Server |
| 88 | TCP/UDP | Kerberos Server | 
| 135 | TCP | MS RPC client-server communication | 
| 389 | TCP/UDP | LDAP Server | 
| 445 | TCP | SMB Authentication and File Sharing | 
| 464 | TCP/UDP | Kerberos Change/Set Password |
| 636 | TCP | LDAP over SSL |
| 3268 | TCP | Catalog | 
| 3269 | TCP | Catalog over SSL | 
| 50000 - 55000 | TCP | RPC |




## Troubleshooting
* **Ports:** Ensure that the necessary ports are not being used by other services on your system. If any port conflicts occur, modify the port mapping in the docker run command.
* **Network:** Make sure that container is using an static IP and it's not already in use in the network.
* **Permissions:** Make sure that the Docker daemon has appropriate permissions to access the necessary directories and ports.
* **Firewall:** If you're running a firewall, make sure it allows traffic on the required ports.




## Bug Tracker

Bugs are tracked on [GitHub Issues](https://github.com/linuxcrafts/samba-dc-ac/issues).
In case of trouble, please check there to see if your issue has already been reported.
If you spotted it first, help us smash it by providing detailed and welcomed feedback.

## Maintainer

* Harol Hunter <hhuntercu.devops@gmail.com>

## Contributing
Contributions to improve this Docker container are welcome! If you find any issues or have suggestions for enhancements, please submit a pull request or open an issue in the GitHub repository.

## License
This project is licensed under the [MIT License](https://opensource.org/licenses/MIT). Feel free to use, modify, and distribute this code for your own projects.
